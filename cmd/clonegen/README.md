# clonegen

Go code generator that creates `Clone()` methods for deep copying structs.

## Installation

```bash
go install github.com/mxkacsa/statediff/cmd/clonegen@latest
```

## Usage

### In your own project

1. Add a `go:generate` directive to your source file:

```go
//go:generate clonegen -type=GameState,Player

type GameState struct {
    Round   int
    Phase   string
    Players []Player
    Scores  map[string]int
}

type Player struct {
    ID    string
    Name  string
    Score int
    Hand  []int
    Config *PlayerConfig
}
```

2. Run code generation:

```bash
go generate ./...
```

This creates `{package}_clone_gen.go` with `Clone()` methods for all specified types.

### Using with statediff

```go
import "github.com/mxkacsa/statediff"

//go:generate clonegen -type=GameState

type GameState struct {
    Round   int
    Players []Player
}

func main() {
    state := statediff.New(GameState{}, &statediff.Config[GameState]{
        Cloner: func(g GameState) GameState { return g.Clone() },
    })
}
```

## Flags

| Flag | Description | Default |
|------|-------------|---------|
| `-type` | Comma-separated list of type names (required) | - |
| `-output` | Output file name | `{package}_clone_gen.go` |
| `-pointer-receiver` | Use pointer receiver `func (src *T) Clone() T` | `false` |
| `-skip-fields` | Comma-separated fields to skip (shallow copy) | - |
| `-clone-method` | Name of clone method to look for on nested types | `Clone` |
| `-verbose` | Print detailed generation info | `false` |

## Supported Types

| Type | Cloning Strategy |
|------|------------------|
| Primitives (`int`, `string`, `bool`, etc.) | Direct assignment |
| `[]T` (slice) | `make` + copy/iterate |
| `[N]T` (array) | Element-wise copy |
| `map[K]V` | `make` + iterate |
| `*T` (pointer) | `nil` check + clone pointed value |
| Nested struct | Calls `Clone()` if available, otherwise field copy |
| `time.Time`, `time.Duration` | Direct assignment (immutable) |
| `interface{}`/`any` | Shallow copy (warning generated) |
| `chan`, `func` | Skipped (warning generated) |
| Embedded structs | Recursively cloned |
| Generic types | Supported (Go 1.18+) |

## Example Output

Input:
```go
type Player struct {
    ID     string
    Name   string
    Score  int
    Hand   []int
    Items  map[string]Item
    Config *Config
}
```

Generated output:
```go
// Code generated by clonegen. DO NOT EDIT.
//go:build !clonegen_ignore

package game

// Clone creates a deep copy of Player
func (src Player) Clone() Player {
    dst := Player{
        ID:    src.ID,
        Name:  src.Name,
        Score: src.Score,
    }

    if src.Hand != nil {
        dst.Hand = make([]int, len(src.Hand))
        copy(dst.Hand, src.Hand)
    }

    if src.Items != nil {
        dst.Items = make(map[string]Item, len(src.Items))
        for k, v := range src.Items {
            dst.Items[k] = v.Clone()
        }
    }

    if src.Config != nil {
        v := src.Config.Clone()
        dst.Config = &v
    }

    return dst
}
```

## Nested Types with Clone()

If a nested type already has a `Clone()` method, it will be called automatically:

```go
type Item struct {
    ID   string
    Data []byte
}

func (i Item) Clone() Item {
    return Item{
        ID:   i.ID,
        Data: append([]byte(nil), i.Data...),
    }
}

type Container struct {
    Items []Item  // Will call Item.Clone() for each element
}
```

## Skipping Fields

Use `-skip-fields` to shallow-copy specific fields:

```bash
clonegen -type=State -skip-fields=Logger,Cache
```

## Build Tag

Generated files include `//go:build !clonegen_ignore` so you can exclude them if needed:

```bash
go build -tags clonegen_ignore ./...
```

## Warnings

The generator produces warnings (as comments) for:
- Interface types (shallow copy only)
- Channel types (skipped)
- Function types (skipped)
- Unexported fields from other packages (skipped)

## Requirements

- Go 1.18+ (for generics support)
- The package being processed must be valid Go code
